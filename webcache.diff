? webcache.diff
? webtraf.patch
Index: tcl/test/test-suite-webcache.tcl
===================================================================
RCS file: /cvsroot/nsnam/ns-2/tcl/test/test-suite-webcache.tcl,v
retrieving revision 1.25
diff -r1.25 test-suite-webcache.tcl
1751c1751
< 	if [catch {set st(avg) [expr double($st(avg)) / $sn]}] {
---
> 	if {$sn == 0 || [catch {set st(avg) [expr double($st(avg)) / $sn]}]} {
Index: tcl/webcache/webtraf.tcl
===================================================================
RCS file: /cvsroot/nsnam/ns-2/tcl/webcache/webtraf.tcl,v
retrieving revision 1.21
diff -r1.21 webtraf.tcl
71c71
< PagePool/WebTraf instproc launch-req { id pid clnt svr ctcp csnk size pobj} {
---
> PagePool/WebTraf instproc launch-req { id pid clnt svr ctcp csnk size} {
106c106
< 	$ctcp proc done {} "$self done-req $id $pid $clnt $svr $ctcp $csnk $size $pobj $timer_"
---
> 	$ctcp proc done {} "$self done-req $id $pid $clnt $svr $ctcp $csnk $size $timer_"
119c119
< PagePool/WebTraf instproc done-req { id pid clnt svr ctcp csnk size pobj timer} {
---
> PagePool/WebTraf instproc done-req { id pid clnt svr ctcp csnk size timer} {
137,138c137,138
<     set delay [$self job_arrival $id $clnt $svr $ctcp $csnk $size $pobj]
<     #$self launch-resp $id $pid $svr $clnt $ctcp $csnk $size $pobj
---
>     set delay [$self job_arrival $id $clnt $svr $ctcp $csnk $size $pid]
>     #$self launch-resp $id $pid $svr $clnt $ctcp $csnk $size
150c150
< 	$self doneObj $pobj
---
> 	$self doneObj $pid
161c161
< PagePool/WebTraf instproc launch-resp { id pid svr clnt stcp ssnk size pobj} {
---
> PagePool/WebTraf instproc launch-resp { id pid svr clnt stcp ssnk size} {
191c191
<     $stcp proc done {} "$self done-resp $id $pid $clnt $svr $stcp $ssnk $size $sent $flow_th [$ns now] [$stcp set fid_] $pobj"
---
>     $stcp proc done {} "$self done-resp $id $pid $clnt $svr $stcp $ssnk $size $sent $flow_th [$ns now] [$stcp set fid_]"
201c201
< PagePool/WebTraf instproc done-resp { id pid clnt svr stcp ssnk size sent sent_th {startTime 0} {fid 0} pobj } {
---
> PagePool/WebTraf instproc done-resp { id pid clnt svr stcp ssnk size sent sent_th {startTime 0} {fid 0} } {
260c260
< 	$self doneObj $pobj
---
> 	$self doneObj $pid
Index: webcache/webserver.cc
===================================================================
RCS file: /cvsroot/nsnam/ns-2/webcache/webserver.cc,v
retrieving revision 1.7
diff -r1.7 webserver.cc
110c110
< double WebServer::job_arrival(int obj_id, Node *clnt, Agent *tcp, Agent *snk, int size, void *data) {
---
> double WebServer::job_arrival(int obj_id, Node *clnt, Agent *tcp, Agent *snk, int size, int pid) {
113c113
<     web_pool_->launchResp(obj_id, node, clnt, tcp, snk, size, data);
---
>     web_pool_->launchResp(obj_id, node, clnt, tcp, snk, size, pid);
127c127
<     new_job->data = data;
---
>     new_job->pid = pid;
154c154
<     web_pool_->launchResp(head->obj_id, node, head->clnt, head->tcp, head->snk, head->size, head->data);
---
>     web_pool_->launchResp(head->obj_id, node, head->clnt, head->tcp, head->snk, head->size, head->pid);
191c191
<       void *data = p->data;
---
>       int pid = p->pid;
196c196
<       p->data = head->data;
---
>       p->pid = head->pid;
201c201
<       head->data = data;
---
>       head->pid = pid;
Index: webcache/webserver.h
===================================================================
RCS file: /cvsroot/nsnam/ns-2/webcache/webserver.h,v
retrieving revision 1.5
diff -r1.5 webserver.h
71c71
<   void *data;
---
>   int pid;
101c101
< 	double job_arrival(int, Node *, Agent *, Agent *, int, void *);
---
> 	double job_arrival(int, Node *, Agent *, Agent *, int, int);
Index: webcache/webtraf.cc
===================================================================
RCS file: /cvsroot/nsnam/ns-2/webcache/webtraf.cc,v
retrieving revision 1.30
diff -r1.30 webtraf.cc
185a186
> 	mgr_->donePage(pg->id());
360a362
> 	pages_[pg->id()] = ClntData;
363c365
< 	Tcl::instance().evalf("%s launch-req %d %d %s %s %s %s %d %d", 
---
> 	Tcl::instance().evalf("%s launch-req %d %d %s %s %s %s %d", 
366c368
< 			      ctcp->name(), csnk->name(), size, ClntData);
---
> 			      ctcp->name(), csnk->name(), size);
379,387c381
< void WebTrafPool::launchResp(int obj_id, Node *svr_, Node *clnt_, Agent *tcp, Agent* snk, int size, void *ClntData) {
< 	int pid;
< 	pid = obj_id;
< 
< 	// Get webpage (client data) if any
< 	if (ClntData) {
< 		WebPage* pg = (WebPage*)ClntData;
< 		pid = pg->id();
< 	}
---
> void WebTrafPool::launchResp(int obj_id, Node *svr_, Node *clnt_, Agent *tcp, Agent* snk, int size, int pid) {
390c384
< 	Tcl::instance().evalf("%s launch-resp %d %d %s %s %s %s %d %d", 
---
> 	Tcl::instance().evalf("%s launch-resp %d %d %s %s %s %s %d", 
392c386
< 			      tcp->name(), snk->name(), size, ClntData);
---
> 			      tcp->name(), snk->name(), size);
412a407,410
> 
> void WebTrafPool::donePage (int pid) {
> 	pages_.erase(pid);
> }
460c458
< 			WebPage* p = (WebPage*)atol(argv[2]);
---
> 			WebPage* p = static_cast<WebPage*> (pages_[atoi(argv[2])]);
624c622
< 			//$self job_arrival $id $clnt $svr $tcp $snk $size $pobj
---
> 			//$self job_arrival $id $clnt $svr $tcp $snk $size $pid
632c630
< 			void* data = (void *)atol(argv[8]);
---
> 			int pid = atoi(argv[8]);
639c637
< 			double delay = server_[n].job_arrival(obj_id, clnt_, tcp, snk, size, data);
---
> 			double delay = server_[n].job_arrival(obj_id, clnt_, tcp, snk, size, pid);
Index: webcache/webtraf.h
===================================================================
RCS file: /cvsroot/nsnam/ns-2/webcache/webtraf.h,v
retrieving revision 1.18
diff -r1.18 webtraf.h
58a59
> #include <map>
126c127
< 	void launchResp(int, Node*, Node*, Agent*, Agent*, int, void*);
---
> 	void launchResp(int, Node*, Node*, Agent*, Agent*, int, int);
139a141
> 	void donePage (int);
205a208,209
> 
> 	std::map<int, void *> pages_;  // Hold pointers to web pages
